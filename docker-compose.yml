name: "eld_xy_minio_hosted"

services:
  minio-hosted:
    image: minio/minio:RELEASE.2023-03-24T21-41-23Z
    container_name: minio-hosted
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console UI
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # IMPORTANT: Set these to your public domain URLs
      MINIO_SERVER_URL: ${MINIO_SERVER_URL}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_CONSOLE_URL}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # One-time bucket initialization
  createbuckets-hosted:
    image: minio/mc:RELEASE.2023-03-23T20-03-04Z
    container_name: minio-init-hosted
    depends_on:
      minio-hosted:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    entrypoint: |
      /bin/sh -c '
      echo "Configuring MinIO alias...";
      mc alias set myminio http://minio-hosted:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};

      echo "Creating main bucket...";
      mc mb myminio/eld-files --ignore-existing;

      echo "Creating folder structure...";
      echo "placeholder" | mc pipe myminio/eld-files/static/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/media/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/signatures/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/documents/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/avatars/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/inspections/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/accidents/.gitkeep;
      echo "placeholder" | mc pipe myminio/eld-files/uploads/temp/.gitkeep;

      echo "Setting bucket policy for public read on all the files...";
      cat <<EOF > /tmp/policy.json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {"AWS": ["*"]},
            "Action": ["s3:GetObject"],
            "Resource": ["arn:aws:s3:::eld-files/*"]
          }
        ]
      }
      EOF

      mc anonymous set-json /tmp/policy.json myminio/eld-files;

      echo "Enabling bucket versioning...";
      mc version enable myminio/eld-files;

      echo "MinIO initialization complete!";
      '

volumes:
  minio_data:
    name: eld_minio_hosted_data
